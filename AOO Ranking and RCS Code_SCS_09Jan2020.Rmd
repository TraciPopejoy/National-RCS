---
title: "AOO Ranking and RCS Code_SCS_09Jan2020"
output: html_notebook
---

```{r}
rm(list=ls())
```

Throughout, SCS will need to update the selected range sizes for AOO. Currently listed as 2 OR 4 but will be reduced to 2. Likely 1km buffer and HUC-12, but SCS is leaving 10km and HUC-8 on the table for now. 5km, 20km buffers, NatureServe, and MCP all removed. 

This code peforms two main tasks:
1. Ranks area of occupancies (AOOs) in order of size (1=smallest, 128=largest) for each of the range size metrics used to estimate AOOs (HUC-8 and HUC-12). For each set of AOO rankings, the code then scales the values between 0 and 1. It then calculates mean and standard deviations for the ranks across the range metrics for each species. It then calculates logarithms(base 10) of AOOs for both range metrics. Sections of code performing the tasks above are labeled 1a through 1j. All AOO data is merged into a single dataframe and exported as a .csv 

2. Calculates Relative Climate Sensitivity index (RCS) for each species and range metric. Can be modified to calculate RCS for other AOO scales. Sections of code performing the tasks above are labeled 2a through 2i, and there are currently 2 sections to this task, one for HUC12, and for 1km point buffers. Resulting output from each section exported as an independent .csv file for the RCS using that range size metric.  

Original code written by J. A. Smith (contact=jennifer.smith@utsa.edu) on 22 Oct 2018, revised by S. C. Silknetter on 09 Jan 2020. 

```{r}
#install.packages(package name) ; run this command for packages that are not installed
library(scales)
library(readr)
library(tidyverse)
library(rgbif)
library(sf)
library(rgdal)
library(sp)
library(rgeos)
library(adehabitatHR)
```

TASK ONE: Calculating Area of Occupancy (AOO) 

1a. Import AOO data from R script 'GBIF data filtering and AOO estimation_11_13_2018'. Output locations in this code are as follows: HUC-8 @ Line 317, HUC-12 @ Line 366, 1km Buffer @ Line 597, 5km Buffer @ Line 601, 10km Buffer @ Line 605, and 20km Buffer @ Line 609.
```{r}
Buffer_1km <- read.csv(file="./Buffer1km_AllSpecies.csv")
Buffer_10km <- read.csv(file="./Buffer10km_AllSpecies.csv")
HUC12 <- read.csv(file="./HUC12_AllSpecies.csv")
HUC8 <- read.csv(file="./HUC8_AllSpecies.csv")
```

1b. Adds columns to each AOO dataframe and stores ranks (rank from 1 to 128 with 1 being the smallest area of occupancy)
```{r}
Buffer_1km$rank1km <- rank(Buffer_1km$total_area_1km)
Buffer_10km$rank10km <- rank(Buffer_10km$total_area_10km)
HUC12$rankHUC12 <- rank(HUC12$total_area_huc12)
HUC8$rankHUC8 <- rank(HUC8$total_area_huc8)
```

1c. Merges the 4 dataframes for the 4 metrics and removes duplicate columns (e.g., species names)
```{r}
MergedAOO<- cbind(Buffer_1km,Buffer_10km, HUC8, HUC12)
All_AOO <- MergedAOO[-c(1,5,6,9,10,13,14)]
```

1d. Creates columns for mean and standard deviation values of ranks to be stored. Means and standard deviations consider AOO values across all range metrics.
```{r}
All_AOO$mean_Rank <-NA
All_AOO$sd_Rank <- NA
```

1e. Loop to calculate and store mean of the 4 ranks in the mean column
```{r}
for(i in 1:nrow(All_AOO)){
  All_AOO[i,]$mean_Rank <- mean(c(All_AOO[i,]$rank1km, All_AOO[i,]$rank10km, All_AOO[i,]$rankHUC8, All_AOO[i,]$rankHUC12), na.rm=TRUE)
}
```

1f. loop to calculate and store standard deviation of the 4 ranks in the sd column
```{r}
for(i in 1:nrow(All_AOO)){
  All_AOO[i,]$sd_Rank <- sd(c(All_AOO[i,]$rank1km,  All_AOO[i,]$rank10km, All_AOO[i,]$rankHUC8, All_AOO[i,]$rankHUC12), na.rm=TRUE)
}
```

1g. Scales mean rank between 0 and 1
```{r}
All_AOO$StandardizedMean <- rescale(All_AOO$mean_Rank, to =c(0,1))
```

1h. Calculates and stores coefficient of variation (cv) for the rankings in a new column entitled 'cv'
```{r}
All_AOO$cv <- (All_AOO$sd_Rank/All_AOO$mean_Rank)*100
```

1i. calculates and stores logarithms (base 10) of AOOs for all 4 range metrics
```{r}
All_AOO$logBuffer1km <- log10(All_AOO$total_area_1km)
All_AOO$logBuffer10km <- log10(All_AOO$total_area_10km)
All_AOO$logHUC8 <- log10(All_AOO$total_area_huc8)
All_AOO$logHUC12 <- log10(All_AOO$total_area_huc12)
```

1j. Write the .csv output file
```{r}
write.csv(All_AOO,"./Output Files/All_AOO_09Jan2020.csv")
```


TASK TWO - Calculating a Rarity and Climate Sensitivity (RCS) Index

######## For HUC 12 ########

2a. Imports standard deviations for climatic data that indicate climate breath for each species at the HUC12 level
```{r}
StandardDevs_HUC12 <- read.csv(file="./HUC12_PRISM_CompleteSD.csv")
#StandardDevs_HUC12 <- StandardDevs_HUC12[ -c(4) ] ##tmean manually removed from .csv
```

2b. Scales standard deviations for each climatic variable (n=5) between 0 and 1
```{r}
StandardDevs_HUC12$SD_TMax_Scale <- ((StandardDevs_HUC12$matrix_sdtmax - min(StandardDevs_HUC12$matrix_sdtmax))/(max(StandardDevs_HUC12$matrix_sdtmax, na.rm=TRUE) - min(StandardDevs_HUC12$matrix_sdtmax, na.rm=TRUE)))

StandardDevs_HUC12$SD_ppt_Scale <- ((StandardDevs_HUC12$matrix_sdppt - min(StandardDevs_HUC12$matrix_sdppt))/(max(StandardDevs_HUC12$matrix_sdppt, na.rm=TRUE) - min(StandardDevs_HUC12$matrix_sdppt, na.rm=TRUE)))

StandardDevs_HUC12$SD_TMaxAug_Scale <- ((StandardDevs_HUC12$matrix_sdtmaxaug - min(StandardDevs_HUC12$matrix_sdtmaxaug))/(max(StandardDevs_HUC12$matrix_sdtmaxaug, na.rm=TRUE) - min(StandardDevs_HUC12$matrix_sdtmaxaug, na.rm=TRUE)))

StandardDevs_HUC12$SD_TMin_Scale <- ((StandardDevs_HUC12$matrix_sdtmin - min(StandardDevs_HUC12$matrix_sdtmin))/(max(StandardDevs_HUC12$matrix_sdtmin, na.rm=TRUE) - min(StandardDevs_HUC12$matrix_sdtmin, na.rm=TRUE)))

StandardDevs_HUC12$SD_TMinJan_Scale <- ((StandardDevs_HUC12$matrix_sdtminjan - min(StandardDevs_HUC12$matrix_sdtminjan))/(max(StandardDevs_HUC12$matrix_sdtminjan, na.rm=TRUE) - min(StandardDevs_HUC12$matrix_sdtminjan, na.rm=TRUE)))
```

2c. Calculates the mean of the 5 scaled standard deviations to derive a mean relative climate breath for each species
```{r}
StandardDevs_HUC12$CS <- ((StandardDevs_HUC12$SD_TMax_Scale + StandardDevs_HUC12$SD_ppt_Scale + StandardDevs_HUC12$SD_TMaxAug_Scale + StandardDevs_HUC12$SD_TMin_Scale + StandardDevs_HUC12$SD_TMinJan_Scale)/5)
```

2d. Rename columns in AOO dataframe and relative climate breadth dataframe so that they match, and thus that the tables can be merged
```{r}
names(All_AOO)[1]<-"Species"
names(StandardDevs_HUC12)[1] <-"Species"
```

2e. Merge AOO dataframe and relative climate breadth dataframe
```{r}
RCS_Data_HUC12 <- merge(All_AOO,StandardDevs_HUC12, by.x="Species")
```

2f. Scales AOOs defined by HUC12 (km) between 0 and 1
```{r}
RCS_Data_HUC12$HUC12_Scale <- ((RCS_Data_HUC12$total_area_huc12 - min(RCS_Data_HUC12$total_area_huc12))/(max(RCS_Data_HUC12$total_area_huc12, na.rm=TRUE) - min(RCS_Data_HUC12$total_area_huc12, na.rm=TRUE)))
```

2g. Scaled AOO for HUC12 and CS values substracted from 1
```{r}
RCS_Data_HUC12$One_Minus_ScaledHUC12 <- (1 - RCS_Data_HUC12$HUC12_Scale)
RCS_Data_HUC12$One_Minus_CSHUC12 <- (1 - RCS_Data_HUC12$CS)
```

2h. Calculate Relative Climate Sensitivity Index by taking average of "1-AOO" and "1-CS"
(large values of RCS indicate species with small AOO and low range of climate variables)
```{r}
RCS_Data_HUC12$RCS <- ((RCS_Data_HUC12$One_Minus_ScaledHUC12 + RCS_Data_HUC12$One_Minus_CSHUC12)/2)
```

2i. Exports RCS data table containing RCS values for the HUC 12 scale
```{r}
write.csv(RCS_Data_HUC12,"./Output Files/RCS_HUC12_09Jan2020.csv")
```


######## For 1km Point Buffers ########

MCM, I think reorganizing this section is important so that it matches the workflow used for  HUC-12. For example, Step 2a pulls a file called "complete_sd" for the HUC, yet for point buffers we pull all variables individually. Also, I feel like the step number/letter combinations should match, except where that would affect order of operations. 

An alternative is to use a loop to have the code run the same protocol for both input datasets, but I'm not sure how to go about that. 

2a. Imports standard deviations for climatic data that indicate climate breath for each species at the HUC12 level
```{r}
SD_1km_ppt <- read.csv(file="./1km_PRISM/sd_ppt.csv")

SD_1km_tmax <- read.csv(file="./1km_PRISM/sd_tmax.csv")

SD_1km_tmaxAug <- read.csv(file="./1km_PRISM/sd_tmaxAug.csv")

SD_1km_tmin <- read.csv(file="./1km_PRISM/sd_tmin.csv")

SD_1km_tminJan <- read.csv(file="./1km_PRISM/sd_tminJan.csv")

SD_1km_all <- data.frame(SD_1km_ppt, SD_1km_tmax, SD_1km_tmaxAug, SD_1km_tmin, SD_1km_tminJan)
SD_1km_all <- SD_1km_all[ -c(3,5,7,9) ]

colnames(SD_1km_all)[colnames(SD_1km_all)=="matrix_sd"] <- "SD_1km_ppt"
colnames(SD_1km_all)[colnames(SD_1km_all)=="matrix_sd.1"] <- "SD_1km_tmax"
colnames(SD_1km_all)[colnames(SD_1km_all)=="matrix_sd.2"] <- "SD_1km_tmaxAug"
colnames(SD_1km_all)[colnames(SD_1km_all)=="matrix_sd.3"] <- "SD_1km_tmin"
colnames(SD_1km_all)[colnames(SD_1km_all)=="matrix_sd.4"] <- "SD_1km_tminJan"
```

2b. Scales standard deviations for each climatic variable (n=5) between 0 and 1
```{r}
SD_1km_all$SD_ppt_Scale <- ((SD_1km_all$SD_1km_ppt - min(SD_1km_all$SD_1km_ppt))/(max(SD_1km_all$SD_1km_ppt, na.rm=TRUE) - min(SD_1km_all$SD_1km_ppt, na.rm=TRUE)))

SD_1km_all$SD_TMax_Scale <- ((SD_1km_all$SD_1km_tmax - min(SD_1km_all$SD_1km_tmax))/(max(SD_1km_all$SD_1km_tmax, na.rm=TRUE) - min(SD_1km_all$SD_1km_tmax, na.rm=TRUE)))

SD_1km_all$SD_TMaxAug_Scale <- ((SD_1km_all$SD_1km_tmaxAug - min(SD_1km_all$SD_1km_tmaxAug))/(max(SD_1km_all$SD_1km_tmaxAug, na.rm=TRUE) - min(SD_1km_all$SD_1km_tmaxAug, na.rm=TRUE))) 

SD_1km_all$SD_TMin_Scale <- ((SD_1km_all$SD_1km_tmin - min(SD_1km_all$SD_1km_tmin))/(max(SD_1km_all$SD_1km_tmin, na.rm=TRUE) - min(SD_1km_all$SD_1km_tmin, na.rm=TRUE))) 

SD_1km_all$SD_TMinJan_Scale <- ((SD_1km_all$SD_1km_tminJan - min(SD_1km_all$SD_1km_tminJan))/(max(SD_1km_all$SD_1km_tminJan, na.rm=TRUE) - min(SD_1km_all$SD_1km_tminJan, na.rm=TRUE)))
```

2c. Calculates the mean of the 5 scaled standard deviations to derive a mean relative climate breath for each species
```{r}
SD_1km_all$CS <- ((SD_1km_all$SD_TMax_Scale + SD_1km_all$SD_ppt_Scale + SD_1km_all$SD_TMaxAug_Scale + SD_1km_all$SD_TMin_Scale + SD_1km_all$SD_TMinJan_Scale)/5)
```

2d. Rename columns in AOO dataframe and relative climate breadth dataframe so that they match, and thus that the tables can be merged. **Not sure why the species names have "_PT" at the end. I assume that is to distinguish them as 'point' data (i.e. 1, 10km point buffers), but I don't see why that's necessary. Assuming it is not, I will rename the outputs from the previous script file (), as well as condense SD into a single file. 
```{r}
names(SD_1km_all)[1] <-"Species"
```

2e. Merge AOO dataframe and relative climate breadth dataframe. 
```{r}
SD_1km_all$Species <- All_AOO$Species 
RCS_Data_1km <- merge(All_AOO,SD_1km_all, by.x="Species")
```

2f. Scales AOOs defined by 1km (km) between 0 and 1
```{r}
RCS_Data_1km$Buffer1km_Scale <- ((RCS_Data_1km$total_area_1km - min(RCS_Data_1km$total_area_1km))/(max(RCS_Data_1km$total_area_1km, na.rm=TRUE) - min(RCS_Data_1km$total_area_1km, na.rm=TRUE))) #for 1km
```

2g. Scaled AOO for 1km and CS values substracted from 1
```{r}
RCS_Data_1km$One_Minus_Scaled1km <- (1 - RCS_Data_1km$Buffer1km_Scale)
RCS_Data_1km$One_Minus_CS1km <- (1 - RCS_Data_1km$CS)
```

2h. Calculate Relative Climate Sensitivity Index by taking average of "1-AOO" and "1-CS" (large values of RCS indicate species with small AOO and low range of climate variables)
```{r}
RCS_Data_1km$RCS <- ((RCS_Data_1km$One_Minus_Scaled1km + RCS_Data_1km$One_Minus_CS1km)/2)
```

2i. Exports RCS data table containing RCS values for the 1km point buffer scale
```{r}
write.csv(RCS_Data_1km,"./Output Files/RCS_1km_09Jan2020.csv")
```
